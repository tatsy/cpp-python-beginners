<!DOCTYPE html>
<html lang="en-us">

<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
  <meta name="description" content="初心者・中級者向けC++/Pythonプログラミング"/>
  <meta name="robots" content="index,follow"/>

  <title>
    
      大津の二値化による境界値の決定 &middot; Programming for Beginners
    
  </title>

  
  <link rel="canonical" href="https://tatsy.github.io/programming-for-beginners/cpp/otsu-binarize/">
  

  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/poole.css">
  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/syntax.css">
  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/lanyon.css">
  <link rel="stylesheet" href="https://tatsy.github.io/programming-for-beginners/public/css/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon" sizes="180x180" href="https://tatsy.github.io/programming-for-beginners/public/apple-touch-icon.png">
  <link rel="icon" sizes="512x512" type="image/png" href="https://tatsy.github.io/programming-for-beginners/public/favicon-512x512.png">
  <link rel="icon" sizes="192x192" type="image/png" href="https://tatsy.github.io/programming-for-beginners/public/favicon-192x192.png">
  <link rel="icon" sizes="32x32" type="image/png" href="https://tatsy.github.io/programming-for-beginners/public/favicon-32x32.png">
  <link rel="icon" sizes="16x16" type="image/png" href="https://tatsy.github.io/programming-for-beginners/public/favicon-16x16.png">
  <link rel="shortcut icon" href="https://tatsy.github.io/programming-for-beginners/public/favicon.ico">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://tatsy.github.io/programming-for-beginners/atom.xml">

  <script type="text/javascript" src="/programming-for-beginners/public/js/jquery.min.js"></script>
  <script type="text/javascript" src="/programming-for-beginners/public/js/lightbox.min.js"></script><script>
MathJax = {
    tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        tags: "ams",
        autoload: {
            color: [],
            colorV2: ['color']
        },
        packages: {'[+]': ['noerrors']}
    },
    chtml: {
        scale: 1.1,
        matchFontHeight: false,
        displayAlign: "left",
        displayIndent: "2em"
    },
    options: {
        renderActions: {
            /* add a new named action to render <script type="math/tex"> */
            find_script_mathtex: [10, function (doc) {
            for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = {node: text, delim: '', n: 0};
                math.end = {node: text, delim: '', n: 0};
                doc.math.push(math);
            }
            }, '']
        }
    },
    loader: {
        load: ['[tex]/noerrors']
    }
};
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-186105178-1', 'auto');
  ga('send', 'pageview');
</script>

  
</head>


<body>

  <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
    styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>初心者・中級者向けC++/Pythonプログラミング</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="https://tatsy.github.io/programming-for-beginners/">Home</a>

    

    
    
      
        
      
    
      
    
      
    
      
    
      
    
      
    

    <a class="sidebar-nav-item" href="https://github.com/tatsy/programming-for-beginners">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2022. All rights reserved.
    </p>
  </div>
</div>


  <!-- Wrap is the content to shift when toggling the sidebar. We wrap the content to avoid any CSS collisions with our real content. -->
  <div class="wrap">
    <div class="masthead">
      <div class="container">
        <h3 class="masthead-title">
          <a href="/programming-for-beginners/" title="Home">Programming for Beginners</a>
          <small>Programming for everyone!</small>
        </h3>
      </div>
    </div>

    <div class="container content">
      <div class="post">
  <h1 class="post-title">大津の二値化による境界値の決定</h1>
  <p>マーチング・キューブ法でボリュームデータをメッシュにする際には、ボリューム内のCT値が一定の場所を結んでできる曲面を抽出する。この曲面を<strong>等値面</strong>と呼ぶ。</p>

<p>一つの材質から構成される物体のCT値は空気の部分と物体の部分の2つに分割でき、それらの場所のCT値はかなり離れた値をとっていることが期待される。このような2つの分布を単一の閾値により分割する際に閾値の値を分布の情報から自動決定する方法として大津の二値化が広く知られている。</p>

<h2 id="大津の二値化の概要">大津の二値化の概要</h2>

<p>大津の二値化では、とある閾値の候補を用いてデータを2つのグループに分けたときに、グループ内の平均分散 $\sigma_W^2$ (下付きの$W$はwithinの意味)とグループ間の分散$\sigma_B^2$ (下付きの$B$はbetweenの意味)を以下のように定義する。</p>

\[\sigma_W^2 = \omega_0 \sigma_0^2 + \omega_1 \sigma_1^2\]

\[\sigma_B^2 = \omega_0 (\mu_0 - \mu)^2 + \omega_1 (\mu_1 - \mu)^2\]

<p>上記の式において、$\mu$はデータ全体の平均、$\mu_0, \mu_1$は各グループでの平均、$\sigma_0^2, \sigma_1^2$は各グループの分散、$\omega_0, \omega_1$は各グループに含まれるデータの割合を表す。それぞれは値$i$を取る確率を$p(i)$, データ長さを$N$, 閾値を$T$として以下のように定義される。</p>

\[\mu = \sum_{i=0}^{N-1} i p(i), \quad
\mu_0 = \frac{\displaystyle \sum_{i=0}^{T-1} i p(i)}{\displaystyle \sum_{i=0}^{T-1} p(i)}, \quad
\mu_1 = \frac{\displaystyle \sum_{i=T}^{N-1} i p(i)}{\displaystyle \sum_{i=T}^{N-1} p(i)}\]

\[\sigma_0^2 = \frac{\displaystyle \sum_{i=0}^{T-1} (\mu_0 - i)^2 p(i)}{\displaystyle \sum_{i=0}^{T-1} p(i)}, \quad
\sigma_1^2 = \frac{\displaystyle \sum_{i=T}^{N-1} (\mu_1 - i)^2 p(i)}{\displaystyle \sum_{i=T}^{N-1} p(i)}\]

\[\omega_0 = \sum_{i=0}^{T-1} p(i), \quad
\omega_1 = \sum_{i=T}^{N-1} p(i)\]

<p>これらを用いると、2つのグループの分散度$\lambda$が、グループ内分散とグループ間分散の比として以下のように表せる。</p>

\[\lambda = \frac{\sigma_B^2}{\sigma_W^2}\]

<p>ただし、実際には$\sigma_B^2 = \sigma^2 - \sigma_W^2$であることから、$\sigma_B^2$が最大となるような閾値を求めれば十分で、さらにグループ間分散は平均だけを使って以下のように書き直せる。</p>

\[\sigma_B^2 = \omega_0 \omega_1 (\mu_0 - \mu_1)^2\]

<p>この値をすべての閾値の候補に対して計算し、最も大きな値を取る(=データが最もはっきり分割できる)閾値を求めるのが大津の二値化のアルゴリズムである。</p>

<h2 id="大津の二値化の実装">大津の二値化の実装</h2>

<p>上記の式に従い、平均と分散を求めようとすると、プログラムとしての効率はどうだろうか？</p>

<p>今、ボリュームデータに含まれているデータはそのCT値の大きさを元にヒストグラム化されているとしよう。データの範囲が$[0, N-1]$とすれば、ヒストグラムとは各 $i \in [0, N-1]$につき、データの出現確率$p(i)$が求まっていることに相当する。</p>

<p>このヒストグラムの値を用いると値の平均ならびに分散は以下のように計算できる。</p>

\[\mu = \sum_{i=0}^{N-1} i p(i)\]

<p>同様に、分散は以下のように計算できる。</p>

\[\sigma^2 = \sum_{i=0}^{N-1} (i - \mu)^2 p(i)\]

<p>これはグループ内の平均や分散についても、同様なので、各グループで平均や分散を求める操作の計算量は$O(N)$と見積もられる。これは上記の式で定義される$\mu_0, \mu_1$を求める場合も同様で、オーダーとしての計算量は$O(N)$である。</p>

<p>今、閾値の候補は$N$個あるから、このままだと計算量は$O(N^2)$になりそうだ。しかし、CT値が16bitの符号なし整数、すなわち0-65535の値で表されていることを考えると$N^2$は$10^9$程度のオーダーとなってしまい、計算量が大きすぎる。</p>

<p>余談になるが、現代のCPUは3GHz程度のクロック数なので、単純な計算が1秒間に$3 \times 10^9$できるが、実際の計算では目安として計算量が$10^7$のオーダーを超えると一瞬では計算が終わらなくなる。</p>

<h3 id="効率的な実装">効率的な実装</h3>

<p>上記の通り、大津の二値化ではグループ間分散が最大となる閾値を選べばよく、この値は各グループ内平均 $\mu_0, \mu_1$から計算できる。繰り返しとなるが、閾値$T$については、これらのグループ内平均は次のように表せる。</p>

\[\begin{aligned}
    \mu_0 &amp;= \frac{1}{\omega_0} \sum_{i=0}^{T-1} i p(i) \\
    \mu_1 &amp;= \frac{1}{\omega_1} \sum_{i=T}^{N-1} i p(i), \\
\end{aligned}\]

<p>この式をよく見ると、Tが1増えたときには、以下の操作を行うことで、平均の値が簡単に更新できることが分かる。</p>

<ul>
  <li>$\omega_0$を$p(T)$増やし、$\omega_1$を$p(T)$減らす。</li>
  <li>$\Sigma$の中に含まれる $i p(i)$を$\mu_1$の側から$\mu_0$の側に移項する。</li>
</ul>

<p>この操作をすれば、いちいち、各閾値$T$に対してヒストグラムの値を足し上げる操作をする必要がないので、非常に効率的であることが分かる。上記の2つの操作はデータの値の範囲に寄らず、同様の操作は各グループの分散を求めるときにも使えるので、結果として大津の二値化の計算量が$O(N)$まで減少する。</p>

<p>ここまでの議論をまとめると、効率的な大津の二値化の実装では、はじめに$T=0$のときのグループ1に対する平均と出現頻度$\omega_1 = 1$を求めておき、閾値を増やすごとに、上記の移項の操作を行いながら、最大の分散度を与える閾値を探索すれば良い。</p>

<p>サンプルプログラムの<code class="highlighter-rouge">mcubes.cpp</code>内にある関数 <code class="highlighter-rouge">getThresholdOtsu</code> に大津の二値化を実装してみよう。</p>

</div>




  
<div id="disqus_thread"></div>
<script type="text/javascript">
(function() {
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'tatsy-github-io';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



    </div>
  </div>

  <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  <footer class="site-footer h-card">
    <data class="u-url" href="//programming-for-beginners/"></data>

    <div class="wrapper">
      <div class="container content">
        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
              <li class="p-name">Programming for Beginners</li>
              <li><a class="u-email" href="mailto:tatsy.mail@gmail.com">tatsy.mail@gmail.com</a></li>
            </ul>
          </div>

          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li>
                <a href="https://github.com/tatsy">
                  <svg class="svg-icon">
                    <use xlink:href="/programming-for-beginners/public/minima-social-icons.svg#github"></use>
                  </svg>
                  <span class="username">tatsy</span>
                </a>
              </li>
            </ul>
          </div>

          <div class="footer-col footer-col-3">
            <p>初心者・中級者向けC++/Pythonプログラミング</p>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script src='/programming-for-beginners/public/js/script.js'></script>

</body>

</html>